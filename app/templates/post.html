{% extends 'base/base.html' %}

{% block content %}
<link href="{{ url_for('static', filename='post_editor/quill.snow.css') }}" rel="stylesheet" />

{% if data.archived %}
<div class="bg-orange-200 w-full mt-4 p-5 border sm:rounded-xl text-lg font-semibold shadow">
    Обьявление закрыто {{data.archived_date}}, исполнитель выбран
</div>
{% endif %}

<form method="POST" enctype='multipart/form-data'>
    
    <div class="mt-5 p-5 border-t sm:border sm:rounded-2xl sm:shadow">
        {% if edit %}
        {{ form.hidden_tag() }}
            <div class="font-semibold text-2xl"> 
                {{ form.title(placeholder='Введите заголовок', class="shadow border p-4 rounded-xl w-full", value=data.title) }} 
            </div>
        {% else %}
        <div class="relative ">
            {% if current_user.is_authenticated and data.author.id == current_user.id and not data.archived %}
            <a class="rounded-xl text-center justify-center grid content-center absolute right-3 top-1 backdrop-blur-sm size-16 border-gray-900 border shadow-md transition hover:rotate-6 hover:scale-125 hover:shadow-xl" href="/edit-post/{{data.id}}">
                <span class="text-2xl mb-2 text-black">✏</span> 
            </a>
            {% endif %}
            <div class="font-semibold text-2xl px-4 break-all"> 
                {{data.title}}
            </div>
        </div>
        {% endif %}

        <div class="mt-5 shrink-0 relative">
            {% if edit %}
                <a class="flex flex-nowrap grow-0 shrink-0 ml-3">
            {% else %}
                <a href="/profile/{{data.author.login}}" class="flex flex-nowrap grow-0 shrink-0 ml-3">
            {% endif %}
                <img class="size-20 rounded-xl" src="{{ url_for('static', filename='avatars/'+data.author.login + '.webp') }}">
                <div class="grid content-center">
                    <p class="text-xl ml-2 font-semibold">{{ data.author.name }}</p>
                </div>
            </a>
        </div>

        <div class="flex-col relative">
            <div class="text-right mr-2 sm:text-xl sm:-mt-7">
                
                {% if edit %}
                    <p class="ml-5"><span class="text-gray-500">Оплата:</span> {{ form.coast(class='text-xl w-40 shadow p-2 rounded-md', placeholder='Зарплата', value=data.coast) }} {{ form.currency(value=data.currency, class='w-20 shadow p-2 rounded-md') }} </p>
                {% else %}
                    <p class="ml-5"><span class="text-gray-500">Оплата:</span> <span class="text-xl sm:text-3xl">{{ data.coast }}</span> {{ data.currency }} </p>
                {% endif %}
            </div>
        </div>
        <div class="mt-4">
            {% if edit %}
                {{ form.data(style="display:none;", id='data') }}
                {{ form.data_text(style="display:none;", id='data_text') }}
                <div class="w-full border rounded-xl h-96 mt-5 resize-none p-2 shadow" id="editor">
                    {{ data.data|safe }}
                </div>
            {% else %}
                <div class="ql-container ql-snow ql-editor bg-gray-100 rounded-xl">{{ data.data|safe }}</div>
            {% endif %}
            {% if edit %}
                <!-- Include the Quill library -->

                <script src="{{ url_for('static', filename='post_editor/quill.js') }}"></script>

                <!-- Initialize Quill editor -->
                <script>
                    const toolbarOptions = [{ header: '2' }, 'bold', 'italic', 'underline', 'strike', { 'list': 'ordered'}, { 'list': 'bullet' }, {'background': 'yellow'}, { 'align': [] }    ];
                    
                    const quill = new Quill('#editor', {
                        theme: 'snow',
                        modules: {
                            toolbar: toolbarOptions
                        }
                });
                </script>
                <div class="flex">
                    <div class="grow w-0 h-0 hidden sm:w-full sm:h-2 sm:flex"></div>
                    {% if not data.new_post %}
                        <a 
                            href="/delete-post/{{data.id}}"
                            class="shadow shadow-black border border-red-600 bg-red-600 text-white p-5 mr-5 rounded-xl mt-5 w-full sm:w-44 text-center cursor-pointer transition-all hover:sm:scale-105"
                        >
                            Удалить
                        </a>
                    {% endif %}
                    <a 
                        onclick="getElementById('data').value = quill.getSemanticHTML(); getElementById('data_text').value = quill.getText().replaceAll('\n', ' '); getElementById('submit').click();"
                        class="shadow shadow-black border border-black bg-black text-white p-5 rounded-xl mt-5 w-full sm:w-44 text-center cursor-pointer transition-all hover:sm:scale-105"
                    >
                        Завершить
                    </a>
                    {{ form.submit(id='submit', style="display:none;") }}
                </div>
            {% endif %}
        </div>
    </div>
</form>



{% if current_user.is_authenticated and data.author.id != current_user.id and not edit %}
<form method="POST">
    {{ form.hidden_tag() }}
    <div class="mt-5 p-5 border-t sm:border sm:rounded-2xl sm:shadow">
        <div class="shrink-0 relative">
                <a class="flex flex-nowrap grow-0 shrink-0 ml-3 mt-3">
                <img class="size-20 rounded-xl" src="{{ url_for('static', filename='avatars/'+ current_user.login + '.webp') }}">
                <div class="flex-row relative">
                    <p class="text-xl ml-2 font-semibold mt-3 leading-4">{{ current_user.name }}</p>
                    <p class="absolute top-11 left-2 w-full">Оценка +209</p>
                </div>
            </a>
        </div>
        {{ form.text(class="border w-full mt-5 rounded-lg p-4 h-52", style="resize: none;") }}
        {% if not responds %}
            {{ form.submit(class='w-full shadow p-3 rounded-xl mt-4 block text-center bg-black text-white cursor-pointer') }} 
        {% else %}
            {{ form.submit(class='w-full shadow p-3 rounded-xl mt-4 border border-black block bg-gray-100 text-center text-black cursor-pointer') }} 
        {% endif %}
    </div>
</form>
{% elif not data.archived and data.author_id == current_user.id %}
    <div class="mt-10">
        {% for respond in responds %}
        <div class="mt-3 p-5 border-t bg-white sm:border sm:rounded-2xl sm:shadow">
            <div class="shrink-0 relative flex">
                <a class="flex flex-nowrap grow-0 shrink-0 ml-3 mt-3" href="/profile/{{respond.author.login}}">
                    <img class="size-20 rounded-xl" src="{{ url_for('static', filename='avatars/'+ respond.author.login + '.webp') }}">
                    <div class="flex-row relative">
                        <p class="text-xl ml-2 font-semibold mt-3 leading-4">{{ respond.author.name }}</p>
                        <p class="absolute top-11 left-2 w-full">Оценка +209</p>
                    </div>
                </a>
                <div class="grow sm:w-52 shrink-0 grid content-center justify-end w-0 h-0 sm:h-auto collapse sm:visible">
                    <a class="w-52 p-3 bg-black rounded-xl text-white text-center cursor-pointer" onclick="getElementById('modal-{{loop.index}}').setAttribute('style', 'display: block')">Выбрать исполнителем</a>
                </div>
            </div>
            <div class="overflow-y-scroll whitespace-pre-wrap h-52 p-4 mt-5 bg-gray-100 rounded-lg">{{respond.text}}</div>
            <a class="w-full mt-5 p-3 bg-black rounded-xl text-white text-center cursor-pointer block sm:hidden" onclick="getElementById('modal-{{loop.index}}').setAttribute('style', 'display: block')">
                Выбрать исполнителем
            </a>
        </div>
        <div id="modal-{{loop.index}}" style="display: none;">
            <div class="fixed w-full h-full top-0 right-0 bg-gradient-to-r from-gray-600 to-gray-900 opacity-15 z-20 transition-all"></div>
            <div class="fixed w-full h-full top-0 right-0 backdrop-blur-sm z-30 grid content-center justify-center transition-all">
                <div class="z-40 w-96 rounded-xl p-5 bg-white opacity-100">
                    <p class="text-xl font-semibold text-center">Вы уверены?</p>
                    <p class="p-2"> Вы хотите выбрать <a href="/profile/{{respond.author.login}}" target="_blank" class="underline">{{respond.author.name}}</a> и закрыть обьявление?</p> 
                    <div class="flex space-x-3 mt-5">
                        <a  
                            class="rounded-lg px-10 shadow py-2 bg-red-700 text-white font-semibold justify-center cursor-pointer mt-5 flex mx-5 sm:mx-0 w-full transition-all hover:sm:scale-105"
                            onclick="getElementById('modal-{{loop.index}}').setAttribute('style', 'display: none')"
                        >
                            Нет
                        </a>
                        <a 
                            class="rounded-lg px-10 shadow py-2 bg-black text-white font-semibold justify-center cursor-pointer mt-5 flex mx-5 sm:mx-0 w-full transition-all hover:sm:scale-105"
                            href="/archiving-post/post{{data.id}}&user{{respond.author_id}}"
                        >
                            Да
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}

    {% for respond in responds %}
    <div class="mt-3 p-5 border-t bg-white sm:border sm:rounded-2xl sm:shadow">
        <div class="shrink-0 relative flex">
            <a class="flex flex-nowrap grow-0 shrink-0 ml-3 mt-3" href="/profile/{{respond.author.login}}">
                <img class="size-20 rounded-xl" src="{{ url_for('static', filename='avatars/'+ respond.author.login + '.webp') }}">
                <div class="flex-row relative">
                    <p class="text-xl ml-2 font-semibold mt-3 leading-4">{{ respond.author.name }}</p>
                    <p class="absolute top-11 left-2 w-full">Оценка +209</p>
                </div>
            </a>
            {% if respond.selected %}
                <div class="grow sm:w-52 shrink-0 grid content-center justify-end w-0 h-0 sm:h-auto collapse sm:visible">
                    <a class="w-52 p-3 bg-white rounded-xl text-black border border-black text-center">Выбран исполнителем</a>
                </div>
            {% endif %}
        </div>
        <div class="overflow-y-scroll whitespace-pre-wrap h-52 p-4 mt-5 bg-gray-100 rounded-lg">{{respond.text}}</div>
        {% if respond.selected %}
            <a class="w-full mt-5 p-3 bg-white rounded-xl text-black border border-black text-center block sm:hidden">
                Выбран исполнителем
            </a>
        {% endif %}
    </div>
    {% endfor %}

{% endif %}

{% endblock %}